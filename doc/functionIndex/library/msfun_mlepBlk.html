<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of msfun_mlepBlk</title>
  <meta name="keywords" content="msfun_mlepBlk">
  <meta name="description" content="% MLEPSIMULINKBLK M-S-Function for E+ Cosimulation block for Simulink.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../functionIndex.html">Home</a> &gt;  <a href="functionIndex.html">library</a> &gt; msfun_mlepBlk.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../functionIndex.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="functionIndex.html">Index for library&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>msfun_mlepBlk
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% MLEPSIMULINKBLK M-S-Function for E+ Cosimulation block for Simulink.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function msfun_mlepBlk(block) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% MLEPSIMULINKBLK M-S-Function for E+ Cosimulation block for Simulink.
   This Matlab S-Function implements the Simulink block for EnergyPlus
   Cosimulation.  It is part of the MLE+ toolbox.  Open the MLE+ Simulink
   library mlepLibrary.slx to use this block.

 This S-function is modified from the original function written by Truong
 Nghiem and distributed with MLE+ v. 1.1. It is modified and redistributed
 under the [TO DO: FIGURE THIS OUT] license.

 SYNTAX:
  msfun_mlepBlk(block)

 INPUTS:
   block =     Simulink block which uses the S-function

 COMMENTS:
 1. This is a Simulink S-function. Its structure and conventions conform
    with the Simulink documentation for S-functions; for more info. see
    doc('S-Function').
 
 2. This function is not intended for use outside of the NREL Campus
    Energy Modeling Simulink library; therefore the error checking and
    documentation are minimal. View the code to see what is going on.

 HISTORY:
   Nov. 2010       Original version by Truong Nghiem
                   (nghiem@seas.upenn.edu) with support for BCVTB
                   protocol v. 2.
                   
                   Original code (C) 2010 by Truong Nghiem;
                   reused with permission.

   Aug. 2013       Modified by Willy Bernal (willyg@seas.upenn.edu) for
                   use with the NREL Campus Energy Modeling project

   Nov. 2013       Modified by Stephen Frank for readability and ease of
                   use

   Jul. 2015       Modified by Willy Bernal to work for the MLE+
                   installation and not only Campus Energy Modeling 
                   Project. 

   Sep. 2018       Modified by Jiri Dostal to be independent of the MLE+.
                   Core is now based on the Willy Bernal version from
                   2015.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function setup(block)</a></li><li><a href="#_sub2" class="code">function ParseParameters(block)</a></li><li><a href="#_sub3" class="code">function SetInputPortSamplingMode(block, port, mode)</a></li><li><a href="#_sub4" class="code">function SetInputPortDimensions(block, port, dimsInfo)</a></li><li><a href="#_sub5" class="code">function Start(block)</a></li><li><a href="#_sub6" class="code">function InitializeConditions(block)</a></li><li><a href="#_sub7" class="code">function Outputs(block)</a></li><li><a href="#_sub8" class="code">function Terminate(block)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% MLEPSIMULINKBLK M-S-Function for E+ Cosimulation block for Simulink.</span>
0002 <span class="comment">%   This Matlab S-Function implements the Simulink block for EnergyPlus</span>
0003 <span class="comment">%   Cosimulation.  It is part of the MLE+ toolbox.  Open the MLE+ Simulink</span>
0004 <span class="comment">%   library mlepLibrary.slx to use this block.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This S-function is modified from the original function written by Truong</span>
0007 <span class="comment">% Nghiem and distributed with MLE+ v. 1.1. It is modified and redistributed</span>
0008 <span class="comment">% under the [TO DO: FIGURE THIS OUT] license.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% SYNTAX:</span>
0011 <span class="comment">%  msfun_mlepBlk(block)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% INPUTS:</span>
0014 <span class="comment">%   block =     Simulink block which uses the S-function</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% COMMENTS:</span>
0017 <span class="comment">% 1. This is a Simulink S-function. Its structure and conventions conform</span>
0018 <span class="comment">%    with the Simulink documentation for S-functions; for more info. see</span>
0019 <span class="comment">%    doc('S-Function').</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% 2. This function is not intended for use outside of the NREL Campus</span>
0022 <span class="comment">%    Energy Modeling Simulink library; therefore the error checking and</span>
0023 <span class="comment">%    documentation are minimal. View the code to see what is going on.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% HISTORY:</span>
0026 <span class="comment">%   Nov. 2010       Original version by Truong Nghiem</span>
0027 <span class="comment">%                   (nghiem@seas.upenn.edu) with support for BCVTB</span>
0028 <span class="comment">%                   protocol v. 2.</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%                   Original code (C) 2010 by Truong Nghiem;</span>
0031 <span class="comment">%                   reused with permission.</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%   Aug. 2013       Modified by Willy Bernal (willyg@seas.upenn.edu) for</span>
0034 <span class="comment">%                   use with the NREL Campus Energy Modeling project</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   Nov. 2013       Modified by Stephen Frank for readability and ease of</span>
0037 <span class="comment">%                   use</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   Jul. 2015       Modified by Willy Bernal to work for the MLE+</span>
0040 <span class="comment">%                   installation and not only Campus Energy Modeling</span>
0041 <span class="comment">%                   Project.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%   Sep. 2018       Modified by Jiri Dostal to be independent of the MLE+.</span>
0044 <span class="comment">%                   Core is now based on the Willy Bernal version from</span>
0045 <span class="comment">%                   2015.</span>
0046 <span class="comment">%</span>
0047 
0048 <a name="_sub0" href="#_subfunctions" class="code">function msfun_mlepBlk(block)</a>
0049     <span class="comment">% Set the basic attributes of the S-function and registers the required</span>
0050     <span class="comment">% callbacks</span>
0051     <a href="#_sub1" class="code" title="subfunction setup(block)">setup</a>(block);
0052 <span class="keyword">end</span>
0053 
0054 <span class="comment">%% Setup</span>
0055 <span class="comment">% Set up the S-function block's basic characteristics</span>
0056 <a name="_sub1" href="#_subfunctions" class="code">function setup(block)</a>
0057 
0058     <span class="keyword">if</span> bdIsLibrary(bdroot), <span class="keyword">return</span>; <span class="keyword">end</span>  
0059     
0060     <span class="comment">%% Parameters</span>
0061     <span class="comment">% Register the number of parameters</span>
0062     block.NumDialogPrms = 10;
0063     
0064     <span class="comment">% TO DO: Implement CheckParameters()</span>
0065     
0066     <span class="comment">% Manually trigger CheckParameters() to check the dialog parameters</span>
0067     <span class="comment">%CheckParameters(block)</span>
0068     
0069     <span class="comment">% Parse the dialog parameters</span>
0070     <a href="#_sub2" class="code" title="subfunction ParseParameters(block)">ParseParameters</a>(block)
0071     
0072     <span class="comment">% Retrieve parameters from user data</span>
0073     d = get_param(block.BlockHandle, <span class="string">'UserData'</span>);
0074 
0075     <span class="comment">%% Ports</span>
0076     <span class="comment">% Input ports:</span>
0077     <span class="comment">%   1 - Vector of EnergyPlus inputs</span>
0078     <span class="comment">%</span>
0079     <span class="comment">% Output ports:</span>
0080     <span class="comment">%   1 - Termination/error flag</span>
0081     <span class="comment">%   2 - EnergyPlus time stamp</span>
0082     <span class="comment">%   3 - Vector of EnergyPlus outputs</span>
0083     
0084     <span class="comment">% Register the number of input ports</span>
0085     block.NumInputPorts  = 1;
0086     
0087     <span class="comment">% Register the number of output ports</span>
0088     block.NumOutputPorts = 3;
0089 
0090     <span class="comment">% Setup port properties to be dynamic</span>
0091     block.SetPreCompInpPortInfoToDynamic;
0092     block.SetPreCompOutPortInfoToDynamic;
0093     
0094     <span class="comment">% Override input port properties</span>
0095     block.InputPort(1).Dimensions  = -1;            <span class="comment">% inherited size</span>
0096     block.InputPort(1).DatatypeID  = 0;             <span class="comment">% double</span>
0097     block.InputPort(1).Complexity  = <span class="string">'Real'</span>;
0098     block.InputPort(1).DirectFeedthrough = true;
0099     
0100     <span class="comment">% Override output port properties</span>
0101     block.OutputPort(1).Dimensions  = 1;            <span class="comment">% flag</span>
0102     block.OutputPort(1).DatatypeID  = 0;            <span class="comment">% double</span>
0103     block.OutputPort(1).Complexity  = <span class="string">'Real'</span>;
0104     block.OutputPort(1).SamplingMode = <span class="string">'sample'</span>;
0105 
0106     block.OutputPort(2).Dimensions  = 1;            <span class="comment">% time</span>
0107     block.OutputPort(2).DatatypeID  = 0;            <span class="comment">% double</span>
0108     block.OutputPort(2).Complexity  = <span class="string">'Real'</span>;
0109     block.OutputPort(2).SamplingMode = <span class="string">'sample'</span>;
0110 
0111     nDim = d.dialog.nout;
0112     block.OutputPort(3).Dimensions  = nDim;         <span class="comment">% output vector</span>
0113     block.OutputPort(3).DatatypeID  = 0;            <span class="comment">% double</span>
0114     block.OutputPort(3).Complexity  = <span class="string">'Real'</span>;
0115     block.OutputPort(3).SamplingMode = <span class="string">'sample'</span>;
0116 
0117     <span class="comment">%% Options</span>
0118     <span class="comment">% Register the sample times: Discrete; no offset</span>
0119     block.SampleTimes = [d.timestep 0];
0120     
0121     <span class="comment">% Set the block simStateCompliance to default</span>
0122     block.SimStateCompliance = <span class="string">'DefaultSimState'</span>;
0123 
0124     <span class="comment">%% Register S-function methods</span>
0125     <span class="comment">% Initialize conditions</span>
0126     block.RegBlockMethod(<span class="string">'InitializeConditions'</span>, @<a href="#_sub6" class="code" title="subfunction InitializeConditions(block)">InitializeConditions</a>);
0127     
0128     <span class="comment">% Set input port properties</span>
0129     block.RegBlockMethod(<span class="string">'SetInputPortDimensions'</span>, @<a href="#_sub4" class="code" title="subfunction SetInputPortDimensions(block, port, dimsInfo)">SetInputPortDimensions</a>);
0130     block.RegBlockMethod(<span class="string">'SetInputPortSamplingMode'</span>, @<a href="#_sub3" class="code" title="subfunction SetInputPortSamplingMode(block, port, mode)">SetInputPortSamplingMode</a>);
0131     
0132     <span class="comment">% Check dialog parameters</span>
0133     <span class="comment">%block.RegBlockMethod('CheckParameters', @CheckParameters);</span>
0134     
0135     <span class="comment">% Simulation start</span>
0136     block.RegBlockMethod(<span class="string">'Start'</span>, @<a href="#_sub5" class="code" title="subfunction Start(block)">Start</a>);
0137     
0138     <span class="comment">% Compute output (required)</span>
0139     block.RegBlockMethod(<span class="string">'Outputs'</span>, @<a href="#_sub7" class="code" title="subfunction Outputs(block)">Outputs</a>);
0140     
0141     <span class="comment">% Simulation end (required)</span>
0142     block.RegBlockMethod(<span class="string">'Terminate'</span>, @<a href="#_sub8" class="code" title="subfunction Terminate(block)">Terminate</a>);
0143     
0144 <span class="keyword">end</span>
0145 
0146 <span class="comment">%% Parse Parameters</span>
0147 <span class="comment">% Parse the dialog parameters and store them in the block user data</span>
0148 <a name="_sub2" href="#_subfunctions" class="code">function ParseParameters(block)</a>
0149     
0150     <span class="keyword">if</span> bdIsLibrary(bdroot), <span class="keyword">return</span>; <span class="keyword">end</span>  
0151     
0152     <span class="comment">% Define names of dialog parameters (in order)</span>
0153     dialogNames = { <span class="keyword">...</span>
0154         <span class="string">'work_dir'</span>, <span class="keyword">...</span><span class="comment">         % Working directory</span>
0155         <span class="string">'rel_path'</span>, <span class="keyword">...</span><span class="comment">         % Working directory is relative path (T/F)</span>
0156         <span class="string">'fname'</span>, <span class="keyword">...</span><span class="comment">            % Name of IDF file</span>
0157         <span class="string">'weather_profile'</span>, <span class="keyword">...</span><span class="comment">  % Name of weather profile file        </span>
0158         <span class="string">'nout'</span>, <span class="keyword">...</span><span class="comment">             % Number of real outputs</span>
0159         <span class="string">'timeout'</span>, <span class="keyword">...</span><span class="comment">          % Communication timeout</span>
0160         <span class="string">'eplus_path'</span>, <span class="keyword">...</span><span class="comment">       % Path to EnergyPlus executable</span>
0161         <span class="string">'bcvtb_dir'</span>, <span class="keyword">...</span><span class="comment">        % Path to BCVTB library</span>
0162         <span class="string">'port'</span>, <span class="keyword">...</span><span class="comment">             % Socket port</span>
0163         <span class="string">'host'</span> };               <span class="comment">% Host machine</span>
0164     
0165     <span class="comment">% Put dialog parameters into data structure</span>
0166     d.dialog = struct();
0167     <span class="keyword">for</span> i = 1:length(dialogNames)
0168         d.dialog.(dialogNames{i}) = block.DialogPrm(i).Data;
0169     <span class="keyword">end</span>
0170     
0171     <span class="comment">% Parse working directory path</span>
0172     <span class="keyword">if</span> isempty(d.dialog.work_dir)
0173         <span class="comment">% Empty = use current working directory</span>
0174         workDir = <span class="string">'.'</span>;
0175         
0176     <span class="keyword">elseif</span> d.dialog.rel_path
0177         <span class="comment">% Parse relative path</span>
0178         <span class="keyword">if</span> strcmp(d.dialog.work_dir(1), filesep)
0179             workDir = [pwd d.dialog.work_dir];
0180         <span class="keyword">else</span>
0181             workDir = [pwd filesep d.dialog.work_dir];
0182         <span class="keyword">end</span>
0183     <span class="keyword">else</span>
0184         <span class="comment">% Use absolute path</span>
0185         workDir = d.dialog.work_dir;
0186     <span class="keyword">end</span>
0187     
0188     <span class="keyword">if</span> strcmp(workDir(end), filesep)
0189         <span class="comment">% Strip trailing file sep</span>
0190         workDir = workDir(1:end-1);
0191     <span class="keyword">end</span>
0192     
0193     <span class="comment">% Parse model file location</span>
0194     idfFile = d.dialog.fname;
0195     <span class="keyword">if</span> strcmpi(d.dialog.fname(end-3:end), <span class="string">'.idf'</span>)
0196         <span class="comment">% Strip extension</span>
0197         idfFile = idfFile(1:end-4);
0198     <span class="keyword">end</span>
0199     
0200     <span class="comment">% Check paths</span>
0201     assert( <span class="keyword">...</span>
0202         exist(workDir, <span class="string">'dir'</span>) &gt; 0, <span class="keyword">...</span>
0203         <span class="string">'EnergyPlusCosim:invalidWorkingDirectory'</span>, <span class="keyword">...</span>
0204         <span class="string">'Specified working directory &quot;%s&quot; does not exist.'</span>, <span class="keyword">...</span>
0205         workDir );
0206     assert( <span class="keyword">...</span>
0207         exist([idfFile,<span class="string">'.idf'</span>], <span class="string">'file'</span>) &gt; 0, <span class="keyword">...</span>
0208         <span class="string">'EnergyPlusCosim:invalidModelFile'</span>, <span class="keyword">...</span>
0209         <span class="string">'Specified IDF file &quot;%s&quot; does not exist.'</span>, <span class="keyword">...</span>
0210         idfFile );
0211     
0212     <span class="comment">% Parse weather file name (may contain '.' in the filename)</span>
0213     epwFile = d.dialog.weather_profile;
0214     <span class="keyword">if</span> strcmpi(epwFile(end-3:end), <span class="string">'.epw'</span>)
0215         <span class="comment">% Strip extension</span>
0216         epwFile = epwFile(1:end-4);
0217     <span class="keyword">end</span>
0218     
0219     d.idfFile = idfFile;
0220     d.epwFile = epwFile;
0221     d.workDir = workDir;
0222     in = mlepReadIDF([idfFile <span class="string">'.idf'</span>],<span class="string">'Timestep'</span>);
0223     d.timestep = 60/str2double(char(in(1).fields{1})) * 60 ;
0224     
0225     <span class="comment">% Save to UserData of the block</span>
0226     set_param(block.BlockHandle, <span class="string">'UserData'</span>, d);
0227     set_param(block.BlockHandle, <span class="string">'UserDataPersistent'</span>, <span class="string">'on'</span>);
0228 <span class="keyword">end</span>
0229 
0230 <span class="comment">%% Set sampling mode for input ports</span>
0231 <span class="comment">% Not sure if really needed?</span>
0232 <a name="_sub3" href="#_subfunctions" class="code">function SetInputPortSamplingMode(block, port, mode)</a>
0233     block.InputPort(port).SamplingMode = mode;
0234 <span class="keyword">end</span>
0235 
0236 <span class="comment">%% Set dimension for input ports</span>
0237 <span class="comment">% Not sure if really needed?</span>
0238 <a name="_sub4" href="#_subfunctions" class="code">function SetInputPortDimensions(block, port, dimsInfo)</a>
0239     block.InputPort(port).Dimensions = dimsInfo;
0240 <span class="keyword">end</span>
0241 
0242 <span class="comment">%% Start</span>
0243 <a name="_sub5" href="#_subfunctions" class="code">function Start(block)</a>
0244     <span class="comment">%% Setup</span>
0245     <span class="comment">% Load user data (includes parsed dialog parameters)</span>
0246     d = get_param(block.BlockHandle, <span class="string">'UserData'</span>);    
0247     
0248     <span class="comment">% Create the mlep object</span>
0249     processobj = mlep;
0250     
0251     <span class="comment">% Setup up mlep</span>
0252     processobj.workDir =        d.workDir;
0253     processobj.idfFile =        d.idfFile;
0254     processobj.epwFile =        d.epwFile;
0255     processobj.acceptTimeout =  d.dialog.timeout*1000; <span class="comment">% s -&gt; ms</span>
0256     processobj.port =           d.dialog.port;
0257     processobj.host =           d.dialog.host;
0258     <span class="keyword">if</span> ~isempty(d.dialog.eplus_path)
0259         processobj.program =    d.dialog.eplus_path;
0260     <span class="keyword">end</span>
0261     <span class="keyword">if</span> ~isempty(d.dialog.bcvtb_dir)
0262         processobj.bcvtbDir =   d.dialog.bcvtb_dir;
0263     <span class="keyword">end</span>
0264     d.processobj = processobj;    
0265     
0266     assert( <span class="keyword">...</span>
0267         isa(processobj, <span class="string">'mlep'</span>), <span class="keyword">...</span>
0268         <span class="string">'EnergyPlusCosim:lostCosimulationProcess'</span>, <span class="keyword">...</span>
0269         <span class="string">'Internal error: Cosimulation process object is lost.'</span> );
0270     
0271     <span class="comment">%% Start mlep</span>
0272     <span class="comment">% Start mlep process</span>
0273     [status, msg] = processobj.start;
0274     processobj.status = status;
0275     processobj.msg = msg;
0276 
0277     assert( <span class="keyword">...</span>
0278         status == 0, <span class="keyword">...</span>
0279         <span class="string">'EnergyPlusCosim:startupError'</span>, <span class="keyword">...</span>
0280         <span class="string">'Cannot start EnergyPlus: %s.'</span>, msg );
0281 
0282     <span class="comment">% Save processobj to UserData of the block</span>
0283     set_param(block.BlockHandle, <span class="string">'UserData'</span>, d);
0284 
0285 <span class="keyword">end</span>
0286 
0287 <span class="comment">%% InitializeConditions:</span>
0288 <a name="_sub6" href="#_subfunctions" class="code">function InitializeConditions(block)</a>
0289     <span class="comment">% Get processobj</span>
0290     d = get_param(block.BlockHandle, <span class="string">'UserData'</span>);
0291     processobj = d.processobj;
0292     assert( <span class="keyword">...</span>
0293         isa(processobj, <span class="string">'mlep'</span>), <span class="keyword">...</span>
0294         <span class="string">'EnergyPlusCosim:lostCosimulationProcess'</span>, <span class="keyword">...</span>
0295         <span class="string">'Internal error: Cosimulation process object is lost.'</span> );
0296 
0297     <span class="comment">%% Accept Socket</span>
0298     [status, msg] = processobj.acceptSocket;
0299         assert( <span class="keyword">...</span>
0300         status == 0, <span class="keyword">...</span>
0301         <span class="string">'EnergyPlusCosim:startupError'</span>, <span class="keyword">...</span>
0302         <span class="string">'Cannot start EnergyPlus: %s.'</span>, msg );
0303 <span class="keyword">end</span>
0304 
0305 <span class="comment">%% Outputs</span>
0306 <a name="_sub7" href="#_subfunctions" class="code">function Outputs(block)</a>
0307     <span class="comment">% Get processobj</span>
0308     d = get_param(block.BlockHandle, <span class="string">'UserData'</span>);
0309     processobj = d.processobj;
0310     assert( <span class="keyword">...</span>
0311         isa(processobj, <span class="string">'mlep'</span>), <span class="keyword">...</span>
0312         <span class="string">'EnergyPlusCosim:lostCosimulationProcess'</span>, <span class="keyword">...</span>
0313         <span class="string">'Internal error: Cosimulation process object is lost.'</span> );
0314 
0315     <span class="comment">% Step EnergyPlus and get outputs</span>
0316     <span class="keyword">if</span> processobj.isRunning
0317         <span class="comment">% MLE+ version number</span>
0318         VERNUMBER = 2;
0319 
0320         <span class="comment">% Send signals to E+</span>
0321         rvaluesOut = block.InputPort(1).Data;
0322         
0323         <span class="comment">% Read data from E+</span>
0324         readpacket = processobj.read;
0325         assert( <span class="keyword">...</span>
0326             ~isempty(readpacket), <span class="keyword">...</span>
0327             <span class="string">'EnergyPlusCosim:readError'</span>, <span class="keyword">...</span>
0328             <span class="string">'Could not read data from EnergyPlus.'</span> );
0329 
0330         <span class="comment">% Decode data</span>
0331         <span class="comment">% (Currently, ivalues and bvalues are not used)</span>
0332         [flag, timevalue, rvaluesIn] = mlepDecodePacket(readpacket);
0333         
0334         <span class="comment">% Process output</span>
0335         <span class="keyword">if</span> flag ~= 0
0336             processobj.stop;
0337             block.OutputPort(1).Data = flag;
0338             <span class="keyword">return</span>;
0339         <span class="keyword">else</span>
0340             <span class="comment">% Case where no data is returned</span>
0341             <span class="keyword">if</span> isempty(rvaluesIn), rvaluesIn = 0; <span class="keyword">end</span>
0342 
0343             <span class="comment">% Set outputs of block</span>
0344             block.OutputPort(1).Data = flag;
0345             block.OutputPort(2).Data = timevalue;
0346             block.OutputPort(3).Data = rvaluesIn(:);
0347         <span class="keyword">end</span>
0348         
0349         <span class="comment">% Write data to E+</span>
0350         processobj.write( <span class="keyword">...</span>
0351             mlepEncodeRealData(VERNUMBER, 0, block.CurrentTime, rvaluesOut));
0352         
0353     <span class="keyword">end</span>
0354 
0355 <span class="keyword">end</span>
0356 
0357 <span class="comment">%% Terminate</span>
0358 <a name="_sub8" href="#_subfunctions" class="code">function Terminate(block)</a>
0359     <span class="comment">% Get processobj</span>
0360     d = get_param(block.BlockHandle, <span class="string">'UserData'</span>);
0361     <span class="keyword">if</span> ~isempty(d) &amp;&amp; isstruct(d)
0362         processobj = d.processobj;
0363         assert( <span class="keyword">...</span>
0364             isa(processobj, <span class="string">'mlep'</span>), <span class="keyword">...</span>
0365             <span class="string">'EnergyPlusCosim:lostCosimulationProcess'</span>, <span class="keyword">...</span>
0366             <span class="string">'Internal error: Cosimulation process object is lost.'</span> );
0367         
0368         <span class="comment">% Stop the running process</span>
0369         <span class="keyword">if</span> processobj.isRunning
0370             processobj.stop;
0371         <span class="keyword">end</span>
0372     <span class="keyword">end</span>
0373     
0374 <span class="keyword">end</span></pre></div>
<hr><address>EnergyPlus Co-simulation Toolbox &copy; 2018</address>
</body>
</html>